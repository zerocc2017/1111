<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="google-site-verification" content="0WoaXwtQt9kY0a6D4SWDtj_eb-mubG5hcqly1gp6MdI">














  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS,">










<meta name="description" content="内购场景就不说了，主要方面调试测试还有审核方面吧！">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS - 苹果内购">
<meta property="og:url" content="https://www.zerocc.com.cn/articles/iOS/iOS-苹果内购.html">
<meta property="og:site_name" content="zerocc博客">
<meta property="og:description" content="内购场景就不说了，主要方面调试测试还有审核方面吧！">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://www.zerocc.com.cn/articles/iOS/iOS-苹果内购.htm/%E5%86%85%E8%B4%AD%E6%B5%81%E7%A8%8B.png">
<meta property="og:updated_time" content="2019-04-20T15:57:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS - 苹果内购">
<meta name="twitter:description" content="内购场景就不说了，主要方面调试测试还有审核方面吧！">
<meta name="twitter:image" content="https://www.zerocc.com.cn/articles/iOS/iOS-苹果内购.htm/%E5%86%85%E8%B4%AD%E6%B5%81%E7%A8%8B.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.zerocc.com.cn/articles/iOS/iOS-苹果内购.html">





  <title>iOS - 苹果内购 | zerocc博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zerocc博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">仗键行天下</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-timemachine">
          <a href="/categories/timeMachine" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            时光沙漏
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.zerocc.com.cn/articles/iOS/iOS-苹果内购.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zerocc">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zerocc博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">iOS - 苹果内购</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-20T19:57:03+08:00">
                2019-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>内购场景就不说了，主要方面调试测试还有审核方面吧！</p>
<a id="more"></a>

<h1 id="一-基础配置填写"><a href="#一-基础配置填写" class="headerlink" title="一. 基础配置填写"></a>一. 基础配置填写</h1><p>登录 storeconnect <strong>( <a href="https://appstoreconnect.apple.com" target="_blank" rel="noopener">https://appstoreconnect.apple.com</a> )</strong> 网站 ，进行相关配置。</p>
<p><strong>1. 协议、税务和银行业务 信息填写</strong></p>
<div style="width: 550px; margin: auto">![协议、税务和银行业务](iOS-苹果内购/协议、税务和银行业务.png)</div>

<p>详细过程就不写了很多。</p>
<p><strong>2. 创建内购产品</strong></p>
<p>点击进入<code>我的 App</code> -&gt; <code>功能</code> 创建添加内购商品，内购产品类型有四种：</p>
<div style="width: 550px; margin: auto">![创建内购商品](iOS-苹果内购/创建内购商品.png)</div>

<ul>
<li><strong>消耗型商品:</strong> 如类似游戏中的钻石，被消耗的去购买其它，要选择消耗型商品；</li>
<li><strong>非消耗型商品:</strong> 如看一部电影需要付2块钱的，无法被消耗的商品，付款后直接得到相应东西，非消耗型消耗一次后在该 APP ID 下都能使用。</li>
<li><strong>自动续期订阅类型商品:</strong> 。。。</li>
<li><strong>非续期订阅类型商品：</strong> 。。。</li>
</ul>
<p>注意：当APP中有过订阅类型商品，注意是有过，创建过再删除也算，这个APP无法被转移账号；</p>
<p>创建完成后就是审核内购商品了略。</p>
<p><strong>3. 添加沙盒测试账号</strong></p>
<div style="width: 550px; margin: auto">![创建内购商品](iOS-苹果内购/添加内购沙盒测试账号.png)</div>

<p>注意：使用的邮箱必须是新的，不能是已绑定或注册过的苹果账号；</p>
<h1 id="二-内购核心代码"><a href="#二-内购核心代码" class="headerlink" title="二. 内购核心代码"></a>二. 内购核心代码</h1><p><strong>1. 正常内购业务简易流程</strong></p>
<ul>
<li>1.1 请求 App Service 创建订单，返回给移动端；</li>
<li>1.2 App 拿到交易信息，调起 IAP 服务发送交易请求(iOS api), 回调代理中将购买的商品添加进购买队列；</li>
<li>1.3 用户确认购买，输入密码确认交易后，IAP 服务通知 App 返回交易结果(IAP 票据信息)；</li>
<li>1.4 App 将获得的 IAP 票据信息上报 App Service;</li>
<li>1.5 App Service 用得到的票据信息请求 IAP Service 进行票据校验；</li>
<li>1.6 IAP Service 将校验结果返回告知给 App Service；</li>
<li>1.7 App Service 将票据校验结果返回告诉 App；</li>
</ul>
<p>交易步骤流程图如下：<br><img src="/articles/iOS/iOS-苹果内购.htm/%E5%86%85%E8%B4%AD%E6%B5%81%E7%A8%8B.png" alt="内购流程"></p>
<p><strong>2. 核心代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation/Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line"></span><br><span class="line">typedef NS_OPTIONS(NSInteger, CCIAPPaymentState) &#123;</span><br><span class="line">    CCIAPPaymentStateSuccess,     // 购买成功</span><br><span class="line">    CCIAPPaymentStateFailed,      // 购买失败</span><br><span class="line">    CCIAPPaymentStateCancle,      // 取消购买</span><br><span class="line">    CCIAPPaymentStateNotArrow,    // 不允许内购</span><br><span class="line">    CCIAPPaymentStateOrderAppStoreLose,</span><br><span class="line">    CCIAPPaymentStateOrderVerifyFailed</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">typedef void (^PurchaseCompletion)(CCIAPPaymentState stateType,NSData *data);</span><br><span class="line">typedef void (^OrderLoseHandler)(CCIAPPaymentState stateType,NSData *data);</span><br><span class="line"></span><br><span class="line">@interface CCIAPManager : NSObject</span><br><span class="line">+ (instancetype)shareCCIAPManager;</span><br><span class="line"></span><br><span class="line">- (void)purchaseWithProductID:(NSString *)productID purchaseCompletion:(PurchaseCompletion)completion;</span><br><span class="line"></span><br><span class="line">- (void)gainLoseOrderHandler:(OrderLoseHandler)handler;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_END</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#import &quot;CCIAPManager.h&quot;</span><br><span class="line">#import &lt;StoreKit/StoreKit.h&gt;</span><br><span class="line"></span><br><span class="line">@interface CCIAPManager ()&lt;SKPaymentTransactionObserver,SKProductsRequestDelegate&gt;</span><br><span class="line">@property (nonatomic, copy) NSString *productID;</span><br><span class="line">@property (nonatomic, copy) PurchaseCompletion completion;</span><br><span class="line">@property (nonatomic, copy) OrderLoseHandler handler;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation CCIAPManager</span><br><span class="line"></span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    [[SKPaymentQueue defaultQueue] removeTransactionObserver:self];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (instancetype)shareCCIAPManager &#123;</span><br><span class="line">    static CCIAPManager *IAPManager = nil;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken,^&#123;</span><br><span class="line">        IAPManager = [[CCIAPManager alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    return IAPManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        // 开始支付事务监听, 并且开始支付凭证验证队列.</span><br><span class="line">        [[SKPaymentQueue defaultQueue] addTransactionObserver:self];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)completionStateType:(CCIAPPaymentState)state data:(NSData *)data &#123;</span><br><span class="line">    if (_completion) &#123;</span><br><span class="line">        _completion(state,data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)orderHandlerStateType:(CCIAPPaymentState)state data:(NSData *)data &#123;</span><br><span class="line">    if (_handler) &#123;</span><br><span class="line">        _handler(state,data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)purchaseWithProductID:(NSString *)productID purchaseCompletion:(PurchaseCompletion)completion &#123;</span><br><span class="line">    if (productID) &#123;</span><br><span class="line">        if ([SKPaymentQueue canMakePayments]) &#123;</span><br><span class="line">            // 1. 开始请求购买</span><br><span class="line">            _productID = productID;</span><br><span class="line">            _completion = completion;</span><br><span class="line">            NSSet *productSet = [NSSet setWithArray:@[productID]];</span><br><span class="line">            SKProductsRequest *request = [[SKProductsRequest alloc] initWithProductIdentifiers:productSet];</span><br><span class="line">            request.delegate = self;</span><br><span class="line">            [request start];</span><br><span class="line">            </span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            [self completionStateType:CCIAPPaymentStateNotArrow data:nil];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)gainLoseOrderHandler:(OrderLoseHandler)handler &#123;</span><br><span class="line">    if ([SKPaymentQueue canMakePayments]) &#123;</span><br><span class="line">        NSArray* transactions = [SKPaymentQueue defaultQueue].transactions;</span><br><span class="line">        // 检测是否有未完成的交易(因为有获得的transactions为空的情况)</span><br><span class="line">        if (transactions.count &gt; 0) &#123;</span><br><span class="line">            SKPaymentTransaction* transaction = [transactions firstObject];</span><br><span class="line">            if (transaction.transactionState == SKPaymentTransactionStatePurchased) &#123;</span><br><span class="line">                NSURL *recepitURL = [[NSBundle mainBundle] appStoreReceiptURL];</span><br><span class="line">                NSData *receiptData = [NSData dataWithContentsOfURL:recepitURL];</span><br><span class="line">                if (!receiptData) &#123; // 发送服务器校验订单，如果为空获取不到则出现掉单情况</span><br><span class="line">                    [self orderHandlerStateType:CCIAPPaymentStateSuccess data:receiptData];</span><br><span class="line">                    [[SKPaymentQueue defaultQueue] finishTransaction:transaction];</span><br><span class="line">                &#125;else &#123; // 还是获取不到服务器去手动补单吧 finish掉 (appStore 返回掉单情况)</span><br><span class="line">                    [self orderHandlerStateType:CCIAPPaymentStateOrderAppStoreLose data:nil];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                [[SKPaymentQueue defaultQueue] finishTransaction:transaction];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        [self orderHandlerStateType:CCIAPPaymentStateNotArrow data:nil];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - SKProductsRequestDelegate</span><br><span class="line">- (void)productsRequest:(SKProductsRequest *)request didReceiveResponse:(SKProductsResponse *)response&#123;</span><br><span class="line">    NSArray *product = response.products;</span><br><span class="line">    if([product count] &gt; 0)&#123; // 存在商品</span><br><span class="line">        SKProduct *p = nil;</span><br><span class="line">        for(SKProduct *pro in product)&#123;</span><br><span class="line">            if([pro.productIdentifier isEqualToString:_productID])&#123;</span><br><span class="line">                p = pro;</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 2. 将购买的商品添加进购买队列</span><br><span class="line">        SKPayment *payment = [SKPayment paymentWithProduct:p];</span><br><span class="line">        [[SKPaymentQueue defaultQueue] addPayment:payment];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;productID:%@&quot;, response.invalidProductIdentifiers);</span><br><span class="line">    NSLog(@&quot;产品付费数量:%lu&quot;,(unsigned long)[product count]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - SKPaymentTransactionObserver</span><br><span class="line">- (void)paymentQueue:(SKPaymentQueue *)queue updatedTransactions:(NSArray&lt;SKPaymentTransaction *&gt; *)transactions &#123;</span><br><span class="line">    // 3. 输入密码确认交易后苹果返回购买回调结果</span><br><span class="line">    for (SKPaymentTransaction *transaction in transactions) &#123;</span><br><span class="line">        switch (transaction.transactionState) &#123;</span><br><span class="line">            case SKPaymentTransactionStatePurchasing:  //正在交易</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            case SKPaymentTransactionStatePurchased:</span><br><span class="line">                [self transactionPurchased:transaction];</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            case SKPaymentTransactionStateRestored:  //恢复交易</span><br><span class="line"></span><br><span class="line">                 [[SKPaymentQueue defaultQueue] finishTransaction:transaction];</span><br><span class="line">                break;</span><br><span class="line">            case SKPaymentTransactionStateFailed:    //交易失败</span><br><span class="line">                [self transactionFailed:transaction];</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            case SKPaymentTransactionStateDeferred:  // 交易状态未确定</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line"></span><br><span class="line">            default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - transactionState</span><br><span class="line"></span><br><span class="line">// 交易中.</span><br><span class="line">- (void)transactionPurchasing:(SKPaymentTransaction *)transaction &#123;</span><br><span class="line">    NSLog(@&quot;交易中...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 交易成功.</span><br><span class="line">- (void)transactionPurchased:(SKPaymentTransaction *)transaction &#123;</span><br><span class="line">    // 4. 获取交易成功的票据</span><br><span class="line">    NSURL *recepitURL = [[NSBundle mainBundle] appStoreReceiptURL];</span><br><span class="line">    NSData *receiptData = [NSData dataWithContentsOfURL:recepitURL];</span><br><span class="line">    </span><br><span class="line">    // 发送服务器校验订单，如果为空获取不到则出现掉单情况</span><br><span class="line">    if (!receiptData) &#123;</span><br><span class="line">        [self completionStateType:CCIAPPaymentStateSuccess data:receiptData];</span><br><span class="line">        [[SKPaymentQueue defaultQueue] finishTransaction:transaction];</span><br><span class="line">    &#125;else &#123; // 一定是掉单了 (appStore 返回掉单情况)</span><br><span class="line">        [self completionStateType:CCIAPPaymentStateOrderAppStoreLose data:nil];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 交易失败.</span><br><span class="line">- (void)transactionFailed:(SKPaymentTransaction *)transaction &#123;</span><br><span class="line">    if (transaction.error.code != SKErrorPaymentCancelled) &#123;</span><br><span class="line">        [self completionStateType:CCIAPPaymentStateFailed data:nil];</span><br><span class="line">     &#125;else &#123;</span><br><span class="line">        [self completionStateType:CCIAPPaymentStateCancle data:nil];</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">     [[SKPaymentQueue defaultQueue] finishTransaction:transaction];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 已经购买过该商品.</span><br><span class="line">- (void)transactionRestored:(SKPaymentTransaction *)transaction &#123;</span><br><span class="line">    NSLog(@&quot;已经购买过该商品...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 交易延期.</span><br><span class="line">- (void)transactionDeferred:(SKPaymentTransaction *)transaction &#123;</span><br><span class="line">    NSLog(@&quot;交易延期...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p><strong>3. 注意事项</strong></p>
<ul>
<li>测试内购必须先在 itune Store 与 App Store 里退出自己的 Apple ID 登录沙箱帐号,否则点击购买会重复弹出 Apple ID 登录框一直让你继续输入;</li>
<li>项目的Bundle identifier需要与您申请 AppID 时填写的 bundleID 一致，不然会无法请求到商品信息;</li>
<li>App Service 校验票据过程区分沙盒环境还是生产环境通过返回 Status Code 决定是否去沙盒进行验证，验证的顺序先验证正式环境，此时若返回值为 21007，就需要去沙盒环境下的校验；</li>
<li>在监听购买结果后，一定要调用 <code>[[SKPaymentQueue defaultQueue] finishTransaction:tran]</code>; 来允许你从支付队列中移除交易，否则下次购买无法购买 IAP 支付队列被阻塞一直是处于 <code>purchasing</code> 的状态;</li>
<li>关于交易事务执行 <code>finishTransaction:</code> 时机问题，很多是等服务器告知 App 校验成功后再进行 <code>finish</code> 操作这样处理，这样好处就是只有没有执行 finish 操作，再次购买就会调用以前已经购买成功的交易事务去购买因为已经购买过如下图弹窗，这是苹果一个自带的补单机制，下次调用 <code>[[SKPaymentQueue defaultQueue] addTransactionObserver:self]</code>后会再次回调<code>(void)paymentQueue:(SKPaymentQueue *)queue updatedTransactions:(NSArray *)transactions</code>方法,这种处理会导致一个问题无法对应到之前 App Service 自身创建的订单号，还有一些例如游戏开服的一些限时活动也无法多次购买(等待服务器结果再finish)服务器压力大等；<div style="width: 350px; margin: auto">![创建内购商品](iOS-苹果内购/已购买过商品.png)</div></li>
<li>我的处理方式是只要拿到 IAP 的票据信息就执行 <code>finishTransaction:</code> 操作，这样不会阻塞交易事务队列，如果后续步骤失败则将 App Service 自身创建的订单号和 IAP 的票据信息一起缓存再进行其它时机上报服务器处理掉单(如果服务器在失败后续处理了则本地缓存删除否则服务器重新检验票据)；</li>
</ul>
<p><strong>4. 丢单处理</strong></p>
<p>苹果自身问题导致的掉单(未执行 <code>finishTransaction</code>):</p>
<ul>
<li>1.3 步骤中交易成功后，获取不到 IAP 的票据信息(receiptData)，弱网情况容易复现这种情况，这是一定是丢单了，通过调用方法 <code>(void)gainLoseOrderHandler:(OrderLoseHandler)handler</code> 其它时机重新获取票据再上报 App Service，或者服务器手动补单通过创建订单时间日期去相应补单(一般补单脚本)；</li>
</ul>
<p>App Service 问题导致的掉单(已经执行 <code>finishTransaction</code>):</p>
<ul>
<li><strong>1.4 步骤</strong>中将获取到的 IAP 的票据信息上传服务器失败，则出现掉单用户无法获取相应的道具，这个时候应该将 IAP 的票据信息和App Service 创建的订单号 和 用户信息一起缓存到本地，最好使用 keychain 进行缓存；</li>
<li><strong>1.6步中</strong> 或者 <strong>1.7 步骤</strong>中异常失败（可能是网络情况导致也有可能是弹窗支付完成后用户关闭了 App 等情况），其导致的可能是 App Service 请求 IAP Service 失败情况或者 App Service 返回 App 失败，也应该进行如上缓存；再在其它合适时机上报 IAP 的票据信息给 App Service；</li>
</ul>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a href="https://developer.apple.com/cn/app-store/Receipt-Validation-Programming-Guide-CN.pdf" target="_blank" rel="noopener">苹果官方票据验证指南</a></li>
<li><a href="https://developer.apple.com/library/archive/technotes/tn2413/_index.html#//apple_ref/doc/uid/DTS40016228-CH1-TNTAG1" target="_blank" rel="noopener">In-App Purchase FAQ</a></li>
<li><a href="https://www.jianshu.com/p/07b5ec193353" target="_blank" rel="noopener">贝聊 IAP 简书</a></li>
<li><a href="https://www.jianshu.com/p/e7722bc578c0" target="_blank" rel="noopener">1.</a></li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/articles/hello-world.html" rel="next" title="Hello World">
                <i class="fa fa-chevron-left"></i> Hello World
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/articles/时光沙漏/后来的我们.html" rel="prev" title="后来的我们">
                后来的我们 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">zerocc</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-基础配置填写"><span class="nav-number">1.</span> <span class="nav-text">一. 基础配置填写</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-内购核心代码"><span class="nav-number">2.</span> <span class="nav-text">二. 内购核心代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考链接"><span class="nav-number">3.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zerocc</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count"></span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>








        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
  
  

  

  

  

</body>
</html>
